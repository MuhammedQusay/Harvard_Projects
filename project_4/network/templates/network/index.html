{% extends "network/layout.html" %}

{% block body %}

  <form method="POST" action="{% url "index" %}" class="card" id="new_post">
    {% csrf_token %}
    <div class="d-flex align-items-center">
      <textarea class="form-control me-2" rows="3" placeholder="Share your thoughts..." name="content"></textarea>
      <button type="submit" class="btn btn-primary">Post</button>
    </div>
  </form>

  {% for post in posts %}
    <div class="card" data-post-id="{{ post.id }}">
      <div class="pp_username" style="align-items: center;">
        <img src="{{ post.poster.profile_picture }}" alt="Profile Picture">
        <p style="margin-bottom: 0; display: flex; align-items: center; gap: 0.5rem;">
          <strong><a href="{% url 'profile' post.poster.id %}">{{ post.poster }}</a></strong>
          <span class="post-date">{{ post.timestamp }}</span>
        </p>
      </div>

      <div class="post-content">
        <pre>{{ post.content }}</pre>
      </div>

      <div class="post-actions">
        <button class="like-btn btn btn-outline-primary" title="Like">
          {% if user.is_authenticated and user in post.likes.all %}
            ‚ù§Ô∏è<span class="likes-count">{{ post.likes.count }}</span>
          {% else %}
            ü§ç<span class="likes-count">{{ post.likes.count }}</span>
          {% endif %}
        </button>

        <a href="{% url 'post_detail' post.id %}" class="btn btn-outline-secondary comment-btn" title="Comments">
          <span class="icon">üí¨</span> <span class="comment-count">{{ post.comments.count }}</span>
        </a>

        <button class="share-btn btn btn-outline-info" title="Share">
          <span class="icon">üîó</span> Share
        </button>

        {% if user == post.poster %}
          <button class="edit-post-btn btn btn-outline-warning" title="Edit Post">‚úèÔ∏è Edit</button>
        {% endif %}
      </div>
    </div>
  {% endfor %}

    <ul class="pagination justify-content-center">
      <li class="page-item"><a class="page-link" href="?page=1"><<</a></li>
      {% if posts.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ posts.previous_page_number }}"><</a></li>
      {% endif %}

      {% for page_num in page_range %}
        {% if page_num == posts.number %}
          <li class="page-item active"><a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a></li>
        {% endif %}
      {% endfor %}

        {% if posts.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ posts.next_page_number }}">></a></li>
        {% endif %}
        <li class="page-item"><a class="page-link" href="?page={{ posts.paginator.num_pages }}">>></a></li>
    </ul>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', () => {
          const card = button.closest('.card');
          const postId = card.getAttribute('data-post-id');
          fetch(`/like/${postId}/`, {
            method: 'POST'
          }).then(response => {
            if (response.redirected) {
              window.location.href = response.url;
              return null;
            } else {
              return response.json()
            }
          })
            .then(data => {
              const likesCountElem = card.querySelector('.likes-count');
              likesCountElem.textContent = data.likes_count;
              button.innerHTML = (data.liked ? '‚ù§Ô∏è' : 'ü§ç') + ' <span class="likes-count">' + data.likes_count + '</span>';
            });
        });
      });

      document.querySelectorAll('.share-btn').forEach(button => {
        button.addEventListener('click', () => {
          const card = button.closest('.card');
          const postId = card.getAttribute('data-post-id');
          const url = window.location.origin + '/post/' + postId + '/';
          navigator.clipboard.writeText(url).then(() => {
            alert('Post URL copied to clipboard!');
          }).catch(() => {
            alert('Failed to copy to clipboard');
          });
        });
      });

      document.querySelectorAll('.edit-post-btn').forEach(button => {
        button.addEventListener('click', () => {
          const card = button.closest('.card');
          const postId = card.getAttribute('data-post-id');
          const postContentDiv = card.querySelector('.post-content');
          const originalContent = postContentDiv.querySelector('pre').textContent;

          postContentDiv.innerHTML = `
        <textarea class="form-control edit-textarea" rows="4">${originalContent}</textarea>
        <div style="margin-top: 0.5rem;">
          <button class="save-edit-btn btn btn-primary btn-sm">Save</button>
          <button class="cancel-edit-btn btn btn-secondary btn-sm">Cancel</button>
        </div>
      `;

          button.disabled = true;

          postContentDiv.querySelector('.save-edit-btn').addEventListener('click', () => {
            const newContent = postContentDiv.querySelector('textarea').value.trim();

            if (newContent.length === 0) {
              alert("Post content cannot be empty.");
              return;
            }

            fetch(`/edit_post/${postId}/`, {
              method: 'POST',
              body: JSON.stringify({ content: newContent }),
            })
              .then(response => {
                if (!response.ok) {
                  if (response.status === 403) {
                    alert("You are not authorized to edit this post.");
                  } else {
                    alert("Failed to update the post.");
                  }
                  throw new Error("Failed to update");
                }
                return response.json();
              })
              .then(data => {
                postContentDiv.innerHTML = `<pre>${data.content}</pre>`;
                button.disabled = false;
              })
              .catch(() => {
                postContentDiv.innerHTML = `<pre>${originalContent}</pre>`;
                button.disabled = false;
              });
          });

          postContentDiv.querySelector('.cancel-edit-btn').addEventListener('click', () => {
            postContentDiv.innerHTML = `<pre>${originalContent}</pre>`;
            button.disabled = false;
          });
        });
      });
    });

  </script>

{% endblock %}